Packager.build do
  target do
    platform 'ubuntu'
    version '14.04'
    package 'deb'
    arch 'amd64'
  end
  dependencies do
    build [
      'libpq5',
      'libpq-dev',
      'software-properties-common'
    ]
    runtime [
      'runit',
      'ruby-interpreter'
    ]
  end
  build do
    name 'fission'
    template :generic
    commands do
      build [
        'mkdir -p $PKG_DIR/usr/local/fission/bin',
        'apt-get install -qy python-software-properties',
        'apt-add-repository -y ppa:brightbox/ruby-ng',
        'apt-get update',
        'apt-get install -qy ruby2.2 ruby2.2-dev',
        'gem install --no-ri --no-rdoc bundler',
        'bundle install --gemfile=gemfiles/fission-complete --path /root/vendor',
        'rm -rf /root/vendor/ruby/*/cache',
        'mv /root/vendor $PKG_DIR/usr/local/fission/',
        'cp scripts/runner $PKG_DIR/usr/local/fission/bin/fission',
        'chmod 0755 $PKG_DIR/usr/local/fission/bin/fission'
      ]
    end
  end
  packaging do
    after_install 'scripts/fission-install'
    after_remove 'scripts/fission-uninstall'
  end
end
